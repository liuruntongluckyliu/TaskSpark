import openai
import streamlit as st  # ç”¨äºå®‰å…¨è¯»å–å¯†é’¥
import sys
import os
sys.path.append(os.path.dirname(__file__))

from ai_simulator import AISimulator
import json
import time
from typing import Dict, Any

class TaskAnalyzer:
    """
    ç»Ÿä¸€çš„ä»»åŠ¡åˆ†æå™¨
    åŒ…è£…æ™ºèƒ½æ¨¡æ‹ŸAIï¼Œæä¾›ç®€å•çš„æ¥å£
    """
    
    def __init__(self):
        """åˆå§‹åŒ–AIåˆ†æå™¨"""
        self.ai = AISimulator(name="TaskSpark AI")
        print(f"ğŸ¤– {self.ai.name} v{self.ai.version} å·²å°±ç»ª")
    
    def analyze_task_with_api(current_state: str, target_task: str, mood: str, difficulty: int) -> dict:
        """
        ä½¿ç”¨OpenRouter APIè°ƒç”¨DeepSeekæ¨¡å‹è¿›è¡Œæ™ºèƒ½åˆ†æ
        """
        # 1. ä»Streamlit Secretså®‰å…¨åœ°è¯»å–APIå¯†é’¥
        # æ³¨æ„ï¼šåœ¨æœ¬åœ°æµ‹è¯•æ—¶ï¼Œéœ€è¦åœ¨`.streamlit/secrets.toml`æ–‡ä»¶ä¸­é…ç½®åŒæ ·çš„é”®å€¼å¯¹
        api_key = st.secrets.get("OPENROUTER_API_KEY")
        
        if not api_key:
            return {"error": "APIå¯†é’¥æœªé…ç½®ã€‚è¯·æ£€æŸ¥Streamlit Secretsè®¾ç½®ã€‚"}

        # 2. åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯ï¼Œä½†æŒ‡å‘OpenRouterçš„ç»ˆç‚¹
        client = openai.OpenAI(
            api_key=api_key,
            base_url="https://openrouter.ai/api/v1"  # å…³é”®ï¼šä½¿ç”¨OpenRouterçš„åœ°å€
        )

        # 3. æ„å»ºä¸€ä¸ªå¼ºå¤§çš„ç³»ç»Ÿæç¤ºè¯ï¼Œå¼•å¯¼AIæ‰®æ¼”ä¸“ä¸šè§’è‰²
        system_prompt = """ä½ æ˜¯ TaskSparkï¼Œä¸€ä½ä¸“ä¸ºADHDåŠå­˜åœ¨æ‰§è¡ŒåŠŸèƒ½å›°éš¾çš„ç”¨æˆ·è®¾è®¡çš„èµ„æ·±æ•™ç»ƒã€‚ä½ æ¸©æš–ã€è€å¿ƒã€å¯Œæœ‰æ´å¯ŸåŠ›ä¸”ç»ä¸è¯„åˆ¤ã€‚ä½ çš„æ ¸å¿ƒä¸“é•¿æ˜¯å¸®åŠ©ç”¨æˆ·å…‹æœâ€œä»»åŠ¡å¯åŠ¨å›°éš¾â€ï¼Œé€šè¿‡æ·±åº¦ç»“åˆç”¨æˆ·**å½“å‰çš„å…·ä½“å¤„å¢ƒ**å’Œ**ä»»åŠ¡çš„å…·ä½“ç»†èŠ‚**ï¼Œå°†çœ‹ä¼¼ä»¤äººé€ƒé¿çš„ä»»åŠ¡æ‹†è§£ä¸ºä¸€ç³»åˆ—å¯æ‰§è¡Œçš„å¾®å°æ­¥éª¤ã€‚

        ä½ çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
        1. **æ·±åº¦æƒ…å¢ƒåˆ†æ**ï¼šä»”ç»†é˜…è¯»ç”¨æˆ·æè¿°çš„**å½“å‰çŠ¶æ€**ï¼ˆå¦‚æ‰€å¤„ç¯å¢ƒã€æƒ…ç»ªã€èº«ä½“æ„Ÿå—ã€å‘¨è¾¹å¹²æ‰°ï¼‰å’Œ**æƒ³å®Œæˆçš„ä»»åŠ¡**ã€‚åˆ†ææ˜¯å“ªäº›å…·ä½“å› ç´ ï¼ˆå¦‚ä»»åŠ¡æ¨¡ç³Šã€æ„ŸçŸ¥åˆ°çš„éš¾åº¦ã€æƒ…ç»ªé˜»åŠ›ã€ç¯å¢ƒå¹²æ‰°ï¼‰å¯¼è‡´äº†å½“å‰çš„â€œå¡ä½â€çŠ¶æ€ã€‚
        2. **ç»“æ„åŒ–å›åº”**ï¼šä½ çš„å›ç­”å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹ç»“æ„ï¼Œä¸”æ¯ä¸€æ­¥éƒ½å¿…é¡»ç´§å¯†æºè‡ªä¸Šä¸€æ­¥çš„åˆ†æï¼Œå½¢æˆè¿è´¯çš„æ”¯æ’‘ï¼š

            **1. å…±æƒ…ä¸é”šå®š**
            *   ç”¨ä¸€ä¸¤å¥è¯ç²¾å‡†åæ˜ ä½ å¯¹ä»–ä»¬å½“å‰å¤„å¢ƒå’Œæƒ…ç»ªçš„ç†è§£ï¼Œè¡¨æ˜ä½ çœ‹åˆ°äº†ä»–ä»¬â€œå¡ä½â€çš„ç‹¬ç‰¹åŸå› ã€‚
            *   **æ˜ç¡®é”šå®š**ï¼šæ¸…æ™°å¤è¿°ä»–ä»¬æƒ³è¦å®Œæˆçš„å…·ä½“ä»»åŠ¡ã€‚

            **2. æ ¸å¿ƒç ´å±€ç‚¹**
            *   åŸºäºä½ çš„æƒ…å¢ƒåˆ†æï¼ŒæŒ‡å‡ºä»â€œå½“å‰çŠ¶æ€â€è¿‡æ¸¡åˆ°â€œä»»åŠ¡å¯åŠ¨â€**æœ€å…³é”®ã€æœ€å¾®å°çš„ä¸€ä¸ªå¿ƒç†æˆ–è¡Œä¸ºè½¬æ¢**ã€‚è¿™åº”æ˜¯æ‰“ç ´åƒµå±€çš„å”¯ä¸€æ”¯ç‚¹ï¼ˆä¾‹å¦‚ï¼šâ€œä»æ€è€ƒâ€˜å¿…é¡»å®Œæˆå…¨éƒ¨â€™è½¬æ¢ä¸ºâ€˜åªéœ€å®šä¹‰æ¸…æ¥šç¬¬ä¸€æ­¥æ˜¯ä»€ä¹ˆâ€™â€ï¼‰ã€‚

            **3. â€œçº³ç±³çº§â€ç¬¬ä¸€æ­¥**
            *   è®¾è®¡ä¸€ä¸ª**æå…¶ç®€å•ã€å‡ ä¹æ— é˜»åŠ›ã€30ç§’å†…å°±èƒ½å®Œæˆ**çš„ç‰©ç†æˆ–å¿ƒç†åŠ¨ä½œã€‚è¿™ä¸€æ­¥å¿…é¡»ç›´æ¥æœåŠ¡äºâ€œæ ¸å¿ƒç ´å±€ç‚¹â€ï¼Œå¹¶å¤©ç„¶å¼•å¯¼å‘ä¸‹ä¸€ä¸ªæ­¥éª¤ï¼ˆä¾‹å¦‚ï¼šä¸æ˜¯â€œå¼€å§‹å†™æŠ¥å‘Šâ€ï¼Œè€Œæ˜¯â€œæ‰“å¼€æ–‡æ¡£ï¼ŒæŠŠæ ‡é¢˜æ‰“å‡ºæ¥â€ï¼‰ã€‚

            **4. æ¸è¿›è·¯çº¿å›¾**
            *   åˆ—å‡ºç´§æ¥ç¬¬ä¸€æ­¥åçš„**2-3ä¸ªè‡ªç„¶è¡”æ¥çš„å°æ­¥éª¤**ã€‚æ¯ä¸ªæ­¥éª¤éƒ½åº”ï¼š
                *   **å…·ä½“**ï¼šæ˜ç¡®åšä»€ä¹ˆã€‚
                *   **å¾®å°**ï¼šé¢„è®¡1-5åˆ†é’Ÿå†…å¯å®Œæˆã€‚
                *   **æœ‰é€»è¾‘**ï¼šåƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œä»å‰ä¸€æ­¥è‡ªç„¶å¼•å‡ºä¸‹ä¸€æ­¥ã€‚
            *   åœ¨æœ€åä¸€æ­¥åï¼Œæç¤ºç”¨æˆ·å±Šæ—¶å¯ä»¥ä¸ä½ ä¸€èµ·è§„åˆ’ä¸‹ä¸€é˜¶æ®µã€‚

            **5. èƒ½é‡é€‚é…è´´å£«**
            *   æ ¹æ®ç”¨æˆ·æœ€åˆæè¿°çš„æƒ…ç»ªçŠ¶æ€ï¼Œæä¾›ä¸€ä¸ªéå¸¸ç®€å•ã€ç”¨äº**è°ƒæ•´è‡ªèº«çŠ¶æ€æˆ–ç¯å¢ƒ**çš„å»ºè®®ï¼Œä»¥æ”¯æŒä»–ä»¬æ‰§è¡Œä¸Šè¿°æ­¥éª¤ï¼ˆä¾‹å¦‚ï¼šå¦‚æœç”¨æˆ·æ„Ÿåˆ° overwhelmï¼Œå¯ä»¥è¯´ï¼šâ€œåœ¨å¼€å§‹ç¬¬ä¸€æ­¥å‰ï¼Œå¯ä»¥å…ˆåšä¸‰æ¬¡ç¼“æ…¢çš„æ·±å‘¼å¸ï¼Œåªå…³æ³¨å‘¼æ°”ã€‚â€ï¼‰ã€‚

        **è¯­è¨€é£æ ¼**ï¼šä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€ï¼Œè¯­æ°”äº²åˆ‡å¦‚ä¸€ä½æ‡‚ä½ çš„æœ‹å‹ã€‚ç›´æ¥ç»™å‡ºå»ºè®®ï¼Œé¿å…è¯´æ•™ã€‚ä½¿ç”¨é¼“åŠ±æ€§ã€å‡è½»å‹åŠ›çš„è¯æ±‡ï¼ˆå¦‚â€œå¯ä»¥â€ã€â€œè¯•è¯•çœ‹â€ã€â€œå“ªæ€•åªæ˜¯â€¦â€¦â€ï¼‰ã€‚"""

        # 4. æ„å»ºç”¨æˆ·è¯·æ±‚ï¼Œæ•´åˆæ‰€æœ‰è¾“å…¥ä¿¡æ¯
        user_prompt = f"""
        ## ç”¨æˆ·çŠ¶æ€
        - **å½“å‰åœ¨åš**ï¼š{current_state}
        - **æƒ³è¦å¼€å§‹**ï¼š{target_task}
        - **å½“ä¸‹æƒ…ç»ª**ï¼š{mood}
        - **å¯åŠ¨éš¾åº¦è‡ªè¯„**ï¼š{difficulty}/10 ï¼ˆ10ä¸ºæœ€éš¾ï¼‰

        è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆä½ çš„åˆ†æã€‚
        """

        try:
            # 5. è°ƒç”¨API
            response = client.chat.completions.create(
                model="nex-agi/deepseek-v3.1-nex-n1:free",  
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                max_tokens=1000,  # æ§åˆ¶å›å¤é•¿åº¦ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
                temperature=0.8,  # æ§åˆ¶åˆ›é€ æ€§ï¼ˆ0.0è¾ƒç¡®å®šï¼Œ1.0è¾ƒéšæœºï¼‰
            )
            
            # 6. æå–å’Œè¿”å›ç»“æœ
            ai_content = response.choices[0].message.content
            
            # ä½ å¯ä»¥æ ¹æ®åŸæœ‰analyze_taskå‡½æ•°è¿”å›çš„æ ¼å¼æ¥æ„å»ºè¿”å›å­—å…¸ï¼Œä¿æŒå…¼å®¹æ€§
            return {
                "task_analysis": {
                    "key_insight": ai_content,  # æˆ–è€…ä½ å¯ä»¥å°è¯•ä»ai_contentä¸­è§£æå‡ºæ›´ç»“æ„åŒ–çš„ä¿¡æ¯
                    "source": "DeepSeek-via-OpenRouter"
                },
                "micro_steps": [],  # å¦‚æœéœ€è¦ï¼Œå¯ä»¥è®©AIåœ¨å›å¤ä¸­ç»“æ„åŒ–è¾“å‡ºï¼Œä½ è¿™é‡Œå†è§£æ
                "encouragement": "AIå·²ä¸ºä½ ç”Ÿæˆä¸“å±ç­–ç•¥ï¼Œè¯·çœ‹ä¸Šæ–¹åˆ†æã€‚",
                "_meta": {
                    "ai_model": "nex-agi/deepseek-v3.1-nex-n1:free",
                    "api_used": True
                }
            }
            
        except openai.APIConnectionError as e:
            return {"error": f"ç½‘ç»œè¿æ¥å¤±è´¥: {e}"}
        except openai.APIError as e:
            return {"error": f"OpenRouter APIè¿”å›é”™è¯¯: {e}"}
        except Exception as e:
            return {"error": f"æœªçŸ¥é”™è¯¯: {e}"}
    
    
    
    def get_progress_encouragement(self, progress: int) -> str:
        """æ ¹æ®è¿›åº¦è·å–é¼“åŠ±è¯­"""
        if progress <= 25:
            return "æœ€éš¾çš„æ˜¯å¼€å§‹ï¼Œä½ å·²ç»åšåˆ°äº†ï¼"
        elif progress <= 50:
            return "25%å®Œæˆï¼ç»§ç»­å‰è¿›ï¼"
        elif progress <= 75:
            return "è¿‡åŠäº†ï¼æœ€è‰°éš¾çš„éƒ¨åˆ†å·²ç»è¿‡å»ï¼"
        elif progress < 100:
            return "75%äº†ï¼èƒœåˆ©åœ¨æœ›ï¼"
        else:
            return "ğŸ‰ ä»»åŠ¡å®Œæˆï¼ä½ å¤ªæ£’äº†ï¼"


# å•ä¾‹å®ä¾‹
_analyzer_instance = None

def get_analyzer() -> TaskAnalyzer:
    """è·å–åˆ†æå™¨å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    global _analyzer_instance
    if _analyzer_instance is None:
        _analyzer_instance = TaskAnalyzer()
    return _analyzer_instance


# æµ‹è¯•å‡½æ•°
def test_ai_engine():
    """æµ‹è¯•AIå¼•æ“"""
    print("ğŸ§ª æµ‹è¯•AIå¼•æ“")
    print("=" * 60)
    
    analyzer = get_analyzer()
    
    # æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        ("èººåœ¨åºŠä¸Šåˆ·æŠ–éŸ³", "å¤ä¹ æœŸæœ«è€ƒè¯•", "procrastinating", 8),
        ("åˆšç¡é†’èººåœ¨åºŠä¸Š", "æ•´ç†æˆ¿é—´", "tired", 6),
        ("ååœ¨æ¡Œå‰å‘å‘†", "å†™å·¥ä½œæŠ¥å‘Š", "anxious", 7)
    ]
    
    for current, task, mood, difficulty in test_cases:
        print(f"\nğŸ“‹ æµ‹è¯•: {current} â†’ {task}")
        
        # åˆ†æä»»åŠ¡
        result = analyzer.analyze_task(current, task, mood, difficulty)
        
        # æ˜¾ç¤ºç»“æœ
        print(f"   ğŸ¯ ä»»åŠ¡ç±»å‹: {result['task_analysis']['task_type']}")
        print(f"   ğŸ“Š éš¾åº¦: {result['task_analysis']['difficulty_level']}")
        print(f"   âš¡ ç­–ç•¥: {result['strategy']['name']}")
        print(f"   ğŸ’¬ é¼“åŠ±: {result['encouragement'][:50]}...")
        print(f"   ğŸ”¢ æ­¥éª¤æ•°: {len(result['micro_steps'])}")
        print(f"   ğŸ¤– AIæ¨¡å‹: {result['_meta']['ai_model']}")
        print(f"   ğŸ“¡ ç¦»çº¿æ¨¡å¼: {result['_meta']['offline_mode']}")
    
    print("\n" + "=" * 60)
    print("âœ… AIå¼•æ“æµ‹è¯•å®Œæˆï¼")
    return True


if __name__ == "__main__":
    test_ai_engine()